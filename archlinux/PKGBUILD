#!/hint/bash
# Maintainer: alescdb

pkgname=air-git
pkgver=0.6.12
pkgrel=1
pkgdesc="A simple ChatGPT & Llama-cpp command line with ansi markdown display (written in Rust)"
arch=("x86_64")
url="https://github.com/alescdb/air.git"
license=('Apache')
makedepends=(rust clang)
conflicts=('aid')
source=('air-git::git+https://github.com/alescdb/air.git')
provides=("air=${pkgver%%.r*}")
b2sums=('SKIP')
options=('!strip')
cuda='auto'

prepare() {
	cd ${pkgname}
}

build() {
	cd ${pkgname}

	FEATURE=""
	if [[ "${cuda}" = "auto" ]]; then
		if [[ -z "$(ldconfig -p | grep -i cuda)" ]]; then
			if [[ ! -z "$CUDA_PATH" && -d "$CUDA_PATH" ]]; then
				cuda=1
			fi
		fi
	fi

	if [[ "${cuda}" = "1" ]]; then
		FEATURE="--features cuda_support"
		echo >&2 "Using CUDA, edit PKGBUILD to disable CUDA (cuda=0)"
	fi
	cargo build --release $FEATURE
}

package() {
	cd ${pkgname}
	name=${pkgname%%-*}
	install -Dm755 ./target/release/$name -T ${pkgdir}/usr/bin/$name
	ln -sf /usr/bin/$name ${pkgdir}/usr/bin/aid
}
